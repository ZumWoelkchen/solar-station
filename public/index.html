<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLAR STATION //</title>
    <style>
        :root { 
            --bg: #0b0c10; --panel: #1f2833; --border: #45a29e; 
            --text: #c5c6c7; --accent: #66fcf1; --alert: #ff4757; --warn: #ffa502; 
            --font-tech: 'Segoe UI', 'Roboto Mono', monospace;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font-tech); margin: 0; overflow-y: scroll; }
        
        nav { 
            background: rgba(11, 12, 16, 0.95); border-bottom: 2px solid var(--accent); 
            height: 60px; display: flex; align-items: center; padding: 0 25px; 
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(5px);
        }
        .brand { font-size: 1.1rem; font-weight: 700; color: #fff; letter-spacing: 1.5px; margin-right: 40px; }
        
        .tabs { display: flex; gap: 10px; height: 100%; overflow-x: auto; }
        .tab { 
            background: transparent; border: none; color: #888; padding: 0 15px; white-space: nowrap;
            cursor: pointer; font-family: var(--font-tech); font-weight: 600; font-size: 0.85rem;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab:hover { color: #fff; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .status-area { margin-left: auto; text-align: right; line-height: 1.2; }
        #utc-clock { font-size: 0.95rem; color: #fff; font-weight: 600; }
        #status { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; }

        .container { max-width: 1850px; margin: 0 auto; padding: 20px; }
        .view-panel { display: none; animation: fadeIn 0.4s ease-out; }
        .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 40px; }
        #dash-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 100%; margin-bottom: 30px; }

        .card { 
            background: var(--panel); border: 1px solid #333; border-radius: 4px; 
            overflow: hidden; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }
        .card-header { 
            background: #151b22; padding: 10px 15px; 
            border-bottom: 1px solid #333; font-size: 0.8rem; font-weight: 600; 
            color: var(--accent); display: flex; justify-content: space-between; align-items: center;
        }
        
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 2px; margin-left: 5px; background: #333; color: #aaa; border: 1px solid #444; }
        .badge.beacon { background: #003300; color: #00ff00; border-color: #005500; }
        .badge.hires { background: #002244; color: #00ccff; border-color: #004488; }

        .media-box { 
            width: 100%; background: #000; flex-grow: 1; 
            display: flex; align-items: center; justify-content: center; 
            min-height: 300px; cursor: pointer; position: relative;
        }
        .media-box img, .media-box video { width: 100%; height: 100%; display: block; object-fit: contain; }

        .zone-title { font-size: 1.2rem; color: #fff; border-bottom: 1px solid var(--border); margin: 30px 0 20px 0; padding-bottom: 10px; font-weight: 300; letter-spacing: 1px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; background: #1a1d21; color: var(--accent); padding: 12px; border-bottom: 1px solid #333; }
        td { padding: 12px; border-bottom: 1px solid #333; color: #ddd; vertical-align: top; }
        tr:nth-child(even) { background: #111; }
        .tag-fast { color: var(--alert); font-weight: bold; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        
        @media (max-width: 1000px) { 
            #dash-stats { grid-template-columns: 1fr; } 
            .media-grid { grid-template-columns: 1fr; }
            #grid-gong { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>

<nav>
    <div class="brand">SOLAR STATION <span style="color:var(--accent)">///</span> </div>
    <div class="tabs">
        <button class="tab active" onclick="switchView('dashboard')">DASHBOARD</button>
        <button class="tab" onclick="switchView('goes')">GOES</button>
        <button class="tab" onclick="switchView('gong')">GONG</button>
        <button class="tab" onclick="switchView('flares')">FLARES</button>
        <button class="tab" onclick="switchView('lasco')">LASCO</button>
        <button class="tab" onclick="switchView('stereo')">STEREO A</button>
        <button class="tab" onclick="switchView('ionosphere')">IONOSPHERE</button>
        <button class="tab" onclick="switchView('ace')">ACE DATA</button>
        <button class="tab" onclick="switchView('seaesrt')">SEAESRT / ENLIL</button>
        <button class="tab" onclick="switchView('vault')">ARCHIVE</button>
    </div>
    <div class="status-area">
        <div id="utc-clock">00:00:00 UTC</div>
        <div id="status">INITIALIZING...</div>
    </div>
</nav>

<div class="container">

    <div id="dashboard" class="view-panel active">
        <div class="zone-title">CRITICAL TELEMETRY</div>
        <div id="dash-stats"></div>
        <div class="zone-title">SOLAR DISK (SDO)</div>
        <div class="media-grid" style="grid-template-columns: repeat(4, 1fr);" id="dash-sun"></div>
        <div class="zone-title">CME EVENT CATALOG (DONKI)</div>
        <div class="card">
            <div style="overflow-x: auto;">
                <table id="donki-table">
                    <thead><tr><th>TIME (UTC)</th><th>VELOCITY (km/s)</th><th>TYPE</th><th>SOURCE</th><th>NOTES</th></tr></thead>
                    <tbody id="donki-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="goes" class="view-panel">
        <div class="zone-title">GOES CCOR-1 CORONAGRAPH</div>
        <div class="media-grid" id="grid-goes"></div>
    </div>

    <div id="gong" class="view-panel">
        <div class="zone-title">NSO/GONG FARSIDE CALIBRATED MAPS</div>
        <div class="media-grid" style="grid-template-columns: 1fr 1fr;" id="grid-gong">
            </div>
    </div>

    <div id="flares" class="view-panel">
        <div class="zone-title">FLARE IMAGERY & ANIMATIONS</div>
        <div class="media-grid" id="grid-flares_visual"></div>
        <div class="zone-title">FLARE DATA PLOTS</div>
        <div class="media-grid" id="grid-flares_data"></div>
    </div>

    <div id="lasco" class="view-panel">
        <div class="zone-title">CORONAGRAPHS (SOHO)</div>
        <div class="media-grid" id="grid-lasco"></div>
    </div>

    <div id="stereo" class="view-panel">
        <div class="zone-title">BEACON TELEMETRY (REAL-TIME)</div>
        <div class="media-grid" id="grid-stereo"></div>
    </div>

    <div id="ionosphere" class="view-panel">
        <div class="zone-title">D-REGION ABSORPTION PREDICTIONS (D-RAP)</div>
        <div class="media-grid" id="grid-ionosphere"></div>
    </div>

    <div id="ace" class="view-panel">
        <div class="zone-title">ACE REAL-TIME SOLAR WIND</div>
        <div class="media-grid" id="grid-ace"></div>
    </div>

    <div id="seaesrt" class="view-panel">
        <div class="zone-title">WSA-ENLIL PREDICTION MODEL</div>
        <div class="media-grid" id="grid-seaesrt"></div>
        <div class="zone-title">GEOSPACE & CHARGING HAZARDS</div>
        <div class="media-grid" id="grid-geospace"></div>
    </div>
    
    <div id="vault" class="view-panel">
        <input type="text" id="search" placeholder="Filter Data..." onkeyup="filterVault()" 
               style="width:100%; padding:15px; background:#151b22; border:1px solid #333; color:var(--text); font-family:var(--font-tech); font-size:1rem; margin-bottom: 20px;">
        <div class="media-grid" id="grid-vault"></div>
    </div>

</div>

<div id="modal" onclick="this.style.display='none'">
    <div id="modal-content"></div>
    <div style="margin-top:10px; color:#fff;" id="modal-caption"></div>
</div>

<script>
    setInterval(() => { document.getElementById('utc-clock').innerText = new Date().toISOString().slice(11, 19) + ' UTC'; }, 1000);
    let allFiles = [];

    async function init() {
        try {
            const ts = new Date().getTime();
            const meta = await fetch(`cache/meta.json?v=${ts}`).then(r => r.json());
            document.getElementById('status').innerText = 'LAST SYNC: ' + meta.lastUpdated;
            allFiles = meta.files || [];

            // 1. DASHBOARD
            const pinned = meta.pinned || [];
            
            const stats = [
                pinned.find(p => p.id.includes('enlil')),
                { filename: 'sdo_hmib.mp4', title: 'SDO MAGNETOGRAM', type: 'video' },
                { filename: 'sdo_hmibc.mp4', title: 'SDO MAGNETOGRAM (COLOR)', type: 'video' },
                { filename: 'sdo_hmii.mp4', title: 'SDO INTENSITYGRAM', type: 'video' },
                { filename: 'latest_094.mp4', title: 'AIA 094 (LIVE)', type: 'video' },
                { filename: 'latest_131.mp4', title: 'AIA 131 (LIVE)', type: 'video' },
                { filename: 'latest_171.mp4', title: 'AIA 171 (LIVE)', type: 'video' },
                { filename: 'latest_193.mp4', title: 'AIA 193 (LIVE)', type: 'video' },
                pinned.find(p => p.id.includes('swx')),
                pinned.find(p => p.id.includes('k-index')),
                pinned.find(p => p.id.includes('aurora')),
                { filename: 'synoptic-map.jpg', title: 'SYNOPTIC ANALYSIS', type: 'image' }
            ].filter(Boolean);

            renderRaw('dash-stats', stats, ts);
            
            const sunImages = [
                { id: 'sdo_171', name: 'AIA 171 (CORONAL LOOPS)' },
                { id: 'sdo_193', name: 'AIA 193 (CORONAL HOLES)' },
                { id: 'sdo_211', name: 'AIA 211 (ACTIVE REGIONS)' },
                { id: 'sdo_304', name: 'AIA 304 (FILAMENTS)' },
                { id: 'sdo_335', name: 'AIA 335 (ACTIVE REGIONS)' },
                { id: 'hmi_mag', name: 'HMI MAGNETOGRAM (POLARITY)' },
                { id: 'hmi_ic', name: 'HMI INTENSITYGRAM (SUNSPOTS)' },
                { id: 'hmi_iic', name: 'HMI CONTINUUM (VISIBLE LIGHT)' }
            ].map(s => ({ filename: s.id + '.jpg', title: s.name, type: 'image' }));
            renderRaw('dash-sun', sunImages, ts);

            // 2. LASCO TAB
            const lasco = meta.files.filter(n => n.category === 'lasco');
            renderRaw('grid-lasco', lasco, ts);

            // 3. GONG TAB (Special Logic: Video + Latest Image)
            const gongVideo = allFiles.find(f => f.filename === 'gong_anim.mp4');
            // Find the alphabetically last (latest date) JPG in the gong category
            const gongImages = allFiles.filter(f => f.category === 'gong' && f.type === 'image').sort((a,b) => a.filename.localeCompare(b.filename));
            const latestGongImg = gongImages[gongImages.length - 1];

            const gongItems = [];
            if(gongVideo) gongItems.push({ filename: 'gong_anim.mp4', title: 'FARSIDE ANIMATION (Past 14 Days)', type: 'video' });
            if(latestGongImg) gongItems.push({ filename: latestGongImg.filename, title: 'LATEST FARSIDE COMPOSITE', type: 'image' });
            
            renderRaw('grid-gong', gongItems, ts);


            // 4. POPULATE OTHER CATEGORIES
            renderRaw('grid-stereo', allFiles.filter(f => f.category === 'stereo'), ts);
            renderRaw('grid-flares_visual', allFiles.filter(f => f.category === 'flares_visual'), ts);
            renderRaw('grid-flares_data', allFiles.filter(f => f.category === 'flares_data'), ts);
            renderRaw('grid-ionosphere', allFiles.filter(f => f.category === 'ionosphere'), ts);
            renderRaw('grid-ace', allFiles.filter(f => f.category === 'ace'), ts);
            renderRaw('grid-goes', allFiles.filter(f => f.category === 'goes'), ts);
            
            const seaesrt = allFiles.filter(f => f.category === 'seaesrt');
            renderRaw('grid-seaesrt', seaesrt.filter(f => f.filename.includes('enlil')), ts);
            renderRaw('grid-geospace', seaesrt.filter(f => !f.filename.includes('enlil')), ts);

            loadLogs();
            filterVault();

        } catch (e) {
            document.getElementById('status').innerText = "CONNECTION LOST";
            document.getElementById('status').style.color = "var(--alert)";
            console.error(e);
        }
    }

    function renderRaw(elId, items, ts) {
        const el = document.getElementById(elId);
        if(!el) return;
        el.innerHTML = items.length ? items.map(item => {
            let fileData = allFiles.find(x => x.filename.endsWith(item.id || item.filename)) || { filename: item.id || item.filename, type: 'image' };
            // Force type override if passed in item
            if(item.type) fileData.type = item.type;
            
            const path = `cache/${fileData.filename}?t=${ts}`;
            const isVid = fileData.type === 'video' || fileData.filename.endsWith('.mp4');
            const clean = item.title || cleanName(item.name || fileData.filename);
            
            return `
            <div class="card">
                <div class="card-header">
                    <span>${clean}</span>
                    ${isVid ? '<span style="color:var(--accent)">LIVE</span>' : ''}
                </div>
                <div class="media-box" onclick="showModal('${path}', ${isVid}, '${clean}')">
                    ${isVid ? `<video src="${path}" autoplay loop muted playsinline></video>` : `<img src="${path}" loading="lazy">`}
                </div>
            </div>`;
        }).join('') : '<div style="color:#666; padding:20px; grid-column:1/-1; text-align:center; border:1px dashed #333">NO DATA</div>';
    }

    function cleanName(n) { 
        if(!n) return 'UNKNOWN';
        return n.replace(/_/g, ' ')
                .replace('stereo', '').replace('flares', '').replace('anim', '').replace('gong', '')
                .replace('.mp4','').replace('.jpg','').replace('.gif','').replace('.png','')
                .replace('primary', '').replace('secondary', '')
                .trim().toUpperCase().slice(0, 30); 
    }

    async function loadLogs() {
        try {
            const data = await fetch(`cache/donki.json?v=${Date.now()}`).then(r=>r.json());
            data.sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
            document.getElementById('donki-body').innerHTML = data.map(d => `<tr><td>${d.startTime.slice(0,16)}</td><td class="${(d.cmeAnalyses?.[0]?.speed||0)>1000?'tag-fast':''}">${d.cmeAnalyses?.[0]?.speed||'-'}</td><td>${d.cmeAnalyses?.[0]?.type||'-'}</td><td>${d.cmeAnalyses?.[0]?.latitude||'-'} / ${d.cmeAnalyses?.[0]?.longitude||'-'}</td><td style="color:#888">${d.note||''}</td></tr>`).join('');
        } catch(e){}
    }

    function showModal(url, isVid, title) {
        const c = document.getElementById('modal-content');
        c.innerHTML = isVid ? `<video src="${url}" controls autoplay loop style="max-width:90vw; max-height:85vh"></video>` : `<img src="${url}" style="max-width:90vw; max-height:85vh">`;
        document.getElementById('modal-caption').innerText = title;
        document.getElementById('modal').style.display = 'flex';
    }

    function switchView(id) {
        document.querySelectorAll('.view-panel').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }
    
    function filterVault() {
        const q = document.getElementById('search').value.toLowerCase();
        renderRaw('grid-vault', allFiles.filter(f => f.filename.toLowerCase().includes(q)).slice(0,50), Date.now());
    }

    init();
</script>
</body>
</html>
